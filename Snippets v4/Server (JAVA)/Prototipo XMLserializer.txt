import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.ParserConfigurationException;

import javax.xml.transform.OutputKeys;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerException;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;

import java.io.File;
import java.io.IOException;
import java.io.StringReader;
import java.io.StringWriter;

import java.util.ArrayList;
import java.util.List;

import org.w3c.dom.*;

import org.xml.sax.InputSource;
import org.xml.sax.SAXException;

public class XMLserializer {

    public static void saveLista(String filePath, List<Oggetto> lista) throws TransformerException, ParserConfigurationException {
        // SALVA SU FILE 
        Document d = serializzaLista(lista);

        TransformerFactory tf = TransformerFactory.newInstance();
        Transformer t = tf.newTransformer();

        t.setOutputProperty(OutputKeys.INDENT, "yes"); // Indentazione
        //t.setOutputProperty(OutputKeys.OMIT_XML_DECLARATION, "yes"); // se volessi omettere la dichiarazione xml

        StreamResult result = new StreamResult(new File(filePath));
        t.transform(new DOMSource(d), result);
    }

    private static Document serializzaLista(List<Oggetto> lista)
            throws ParserConfigurationException, TransformerException {

        DocumentBuilderFactory f = DocumentBuilderFactory.newInstance();
        DocumentBuilder b = f.newDocumentBuilder();
        Document d = b.newDocument();

        // Creazione della lista sottoforma di root nel documento
        Element root = d.createElement("Oggetti");
        d.appendChild(root);

        Element oggetto;

        for (Oggetto o : lista) {
            /* Utilizzo il metodo serialize(Document d) (dovrai crearlo)
               nella classe dell'oggeto per farmi restituire
               quell'oggetto serializzato, il tutto sottoforma di Document, cosicchè io 
               ne possa fare l'append in "d" facilmente (nota bene che dovrai passargli
               il document di questa funzione in modo da utilizzarlo anche nel metodo 
               serialize dell'oggetto stesso per poterne poi permettere l'append a "d")*/
            root.appendChild(o.serialize(d));
        }

        return d;
    }

    public static List<Oggetto> read(String filePath) throws SAXException, IOException, ParserConfigurationException {
        // introduzione al parsing XML
        DocumentBuilderFactory f = DocumentBuilderFactory.newInstance();
        DocumentBuilder b = f.newDocumentBuilder();
        Document d = b.parse(filePath);

        List<Oggetto> lista = new ArrayList<Oggetto>();

        NodeList nList = d.getElementsByTagName("Oggetto"); // Lista di oggetti non parsata

        if (nList.getLength() > 0) {
            for (int i = 0; i < nList.getLength(); i++) {
                Element oggetto = (Element) nList.item(i);

                Oggetto o = new Oggetto(oggetto);

                lista.add(o);
            }
        }

        return lista;
    }

    public static String parseTagName(Element oggetto, String tagName) {
        NodeList tmp = oggetto.getElementsByTagName(tagName);
        if (tmp.getLength() == 0)
            return null;

        return tmp.item(0).getTextContent();
    }

    public static String parseAttribute(Element oggetto, String attributeName) {
        String attribute = oggetto.getAttribute(attributeName);

        return attribute;
    }

    // Nel caso servisse buttare in un file direttamente un oggetto serializzato in append
    public static void saveOggetto(Oggetto o, String filePath)
            throws ParserConfigurationException, IOException, TransformerException {

        File file = new File(filePath);
        FileWriter fw = new FileWriter(file, true);
        Document d = o.serialize();
        fw.write(stringfy(d));
        fw.flush(); // svuota il buffer di scrittura, forza la scrittura sul disco
        fw.close(); // chiude il file, occorre riaprirlo se si vorrà fare un altra scrittura
    }

    public static String stringfy(Document d) throws TransformerException {
        // SALVA SU STRINGA
        // Creare un oggetto Transformer per la trasformazione in stringa
        TransformerFactory tf = TransformerFactory.newInstance();
        Transformer t = tf.newTransformer();

        t.setOutputProperty(OutputKeys.INDENT, "yes"); // Indentazione
        //t.setOutputProperty(OutputKeys.OMIT_XML_DECLARATION, "yes"); // se volessi omettere la dichiarazione xml

        StringWriter writer = new StringWriter();
        t.transform(new DOMSource(d), new StreamResult(writer));
        String xmlString = writer.toString();
        return xmlString;
    }

    // Per ricavare il comando inviato dal client a partire dalla stringa recieved
    public static String getCommand(String recieved) throws SAXException, IOException, ParserConfigurationException {
        DocumentBuilderFactory f = DocumentBuilderFactory.newInstance();
        DocumentBuilder b = f.newDocumentBuilder();

        // Il metodo parse del dbuilder lavora solo con file o stream, quindi
        // convertiamo la stringa prima di passarla
        InputSource is = new InputSource(new StringReader(recieved));
        Document d = b.parse(is);

        // Il primo elemento presente nell'XML inviato dal client identifica il comando
        // da eseguire
        Element root = d.getDocumentElement();

        return root.getTagName(); // Lo ricavo dal nome del tag
    }

    public static Oggetto getArgomento(String recieved) throws ParserConfigurationException, SAXException, IOException {
        DocumentBuilderFactory f = DocumentBuilderFactory.newInstance();
        DocumentBuilder b = f.newDocumentBuilder();

        // Il metodo parse del dbuilder lavora solo con file o stream, quindi
        // convertiamo la stringa prima di passarla
        InputSource is = new InputSource(new StringReader(recieved));
        Document d = b.parse(is);

        Element oggetto = d.getDocumentElement();
        Oggetto o = new Oggetto(o);

        return o;
    }
}
